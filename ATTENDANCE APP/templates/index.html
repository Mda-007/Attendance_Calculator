<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#6EE7B7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Attendance">
    <style>
        :root {
            --bg: #0d0f14; --card: #13161e; --card-hover: #181c27;
            --border: rgba(255,255,255,0.07);
            --accent: #6EE7B7; --accent2: #3B82F6;
            --danger: #F87171; --warn: #FBBF24;
            --text: #e8eaf0; --muted: #6b7280;
        }
        * { box-sizing: border-box; }
        body { background:var(--bg); font-family:'DM Sans',sans-serif; color:var(--text); min-height:100vh; padding-bottom:4rem; }
        body::before, body::after { content:''; position:fixed; border-radius:50%; filter:blur(100px); opacity:0.1; pointer-events:none; z-index:0; }
        body::before { width:600px;height:600px;background:var(--accent2);top:-200px;left:-200px; }
        body::after  { width:500px;height:500px;background:var(--accent);bottom:-150px;right:-150px; }
        .content { position:relative; z-index:1; }

        /* Topbar */
        .topbar { border-bottom:1px solid var(--border); background:rgba(13,15,20,0.88); backdrop-filter:blur(12px); padding:1rem 2rem; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
        .brand { font-family:'Syne',sans-serif; font-size:1rem; font-weight:700; letter-spacing:0.12em; text-transform:uppercase; color:var(--accent); display:flex; align-items:center; gap:8px; text-decoration:none; }
        .brand-dot { width:8px;height:8px;background:var(--accent);border-radius:50%; }
        .btn-logout { font-size:0.82rem; font-weight:500; letter-spacing:0.05em; text-transform:uppercase; color:var(--muted); border:1px solid var(--border); background:transparent; border-radius:8px; padding:0.4rem 1rem; text-decoration:none; transition:color 0.2s,border-color 0.2s; }
        .btn-logout:hover { color:var(--danger); border-color:rgba(248,113,113,0.4); }

        /* Tabs */
        .tabs { display:flex; border-bottom:1px solid var(--border); margin-bottom:2rem; margin-top:1.5rem; }
        .tab-btn { font-family:'Syne',sans-serif; font-size:0.82rem; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; background:transparent; border:none; color:var(--muted); padding:0.75rem 1.5rem; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-1px; transition:color 0.2s,border-color 0.2s; }
        .tab-btn.active { color:var(--accent); border-bottom-color:var(--accent); }
        .tab-btn:hover:not(.active) { color:var(--text); }
        .tab-pane { display:none; }
        .tab-pane.active { display:block; }

        .page-header { padding:2rem 0 0; }
        .page-header h1 { font-family:'Syne',sans-serif; font-size:2rem; font-weight:800; margin-bottom:0.2rem; }
        .page-header p { color:var(--muted); font-size:0.9rem; margin:0; }

        /* Today cards */
        .today-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:1rem 1.25rem; margin-bottom:0.75rem; display:flex; align-items:center; gap:1rem; flex-wrap:wrap; animation:fadeUp 0.35s ease both; transition:border-color 0.2s; }
        .today-card:hover { border-color:rgba(110,231,183,0.15); }
        .today-card.status-safe    { border-left:3px solid var(--accent); }
        .today-card.status-warning { border-left:3px solid var(--warn); }
        .today-card.status-danger  { border-left:3px solid var(--danger); }
        .today-info { flex:1; min-width:150px; }
        .today-name { font-family:'Syne',sans-serif; font-weight:700; font-size:1rem; }
        .today-meta { font-size:0.78rem; color:var(--muted); margin-top:3px; line-height:1.6; }
        .today-pct  { font-family:'Syne',sans-serif; font-weight:800; font-size:1.5rem; min-width:64px; text-align:right; }
        .today-actions { display:flex; gap:0.5rem; }

        /* Add form */
        .add-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1.4rem 1.5rem; margin-bottom:2rem; }
        .add-card-title { font-family:'Syne',sans-serif; font-size:0.78rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); margin-bottom:1rem; }
        .add-card .form-control, .add-card .form-select { background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:10px; color:var(--text); font-family:'DM Sans',sans-serif; padding:0.65rem 1rem; }
        .add-card .form-control::placeholder { color:var(--muted); }
        .add-card .form-select option { background:#1a1d27; }
        .add-card .form-control:focus, .add-card .form-select:focus { background:rgba(255,255,255,0.06); border-color:var(--accent); box-shadow:0 0 0 3px rgba(110,231,183,0.1); color:var(--text); }
        .form-hint { font-size:0.75rem; color:var(--muted); margin-top:4px; }
        .day-picker { display:flex; gap:6px; flex-wrap:wrap; }
        .day-picker input[type=checkbox] { display:none; }
        .day-label { font-family:'Syne',sans-serif; font-size:0.72rem; font-weight:700; letter-spacing:0.05em; text-transform:uppercase; border:1px solid var(--border); border-radius:8px; padding:0.35rem 0.7rem; cursor:pointer; color:var(--muted); transition:all 0.15s; user-select:none; }
        .day-picker input:checked + .day-label { background:rgba(110,231,183,0.12); border-color:rgba(110,231,183,0.35); color:var(--accent); }
        .btn-add { font-family:'Syne',sans-serif; font-weight:700; font-size:0.88rem; letter-spacing:0.05em; text-transform:uppercase; background:linear-gradient(135deg,var(--accent),var(--accent2)); border:none; border-radius:10px; color:#0d0f14; padding:0.65rem 1.6rem; width:100%; margin-top:0.75rem; transition:opacity 0.2s,transform 0.15s; }
        .btn-add:hover { opacity:0.88; transform:translateY(-1px); }

        /* Semester */
        .semester-header { display:flex; align-items:center; gap:12px; margin:2rem 0 1rem; }
        .semester-badge { font-family:'Syne',sans-serif; font-size:0.78rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; background:rgba(59,130,246,0.12); border:1px solid rgba(59,130,246,0.25); color:var(--accent2); border-radius:8px; padding:0.3rem 0.9rem; }
        .semester-line { flex:1; height:1px; background:var(--border); }

        /* Subject card */
        .subject-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1.4rem 1.5rem; margin-bottom:1rem; transition:border-color 0.2s,background 0.2s; animation:fadeUp 0.4s ease both; }
        .subject-card:hover { border-color:rgba(110,231,183,0.12); background:var(--card-hover); }
        .subject-card.status-safe    { border-left:3px solid var(--accent); }
        .subject-card.status-warning { border-left:3px solid var(--warn); }
        .subject-card.status-danger  { border-left:3px solid var(--danger); }

        @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

        .subject-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:0.75rem; }
        .subject-name { font-family:'Syne',sans-serif; font-size:1.1rem; font-weight:700; }
        .held-badge { font-size:0.75rem; color:var(--muted); background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:6px; padding:0.2rem 0.6rem; white-space:nowrap; }

        .days-row { display:flex; gap:5px; flex-wrap:wrap; margin-bottom:1rem; align-items:center; }
        .day-pill { font-family:'Syne',sans-serif; font-size:0.68rem; font-weight:700; letter-spacing:0.04em; text-transform:uppercase; border-radius:6px; padding:0.2rem 0.55rem; border:1px solid; }
        .day-pill-on  { background:rgba(110,231,183,0.1); border-color:rgba(110,231,183,0.25); color:var(--accent); }
        .day-pill-off { background:rgba(255,255,255,0.03); border-color:var(--border); color:var(--muted); }

        /* Dual % display */
        .pct-display { display:flex; gap:1rem; margin-bottom:1rem; }
        .pct-box { flex:1; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:12px; padding:0.85rem 1rem; }
        .pct-box-label { font-size:0.7rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); margin-bottom:4px; }
        .pct-box-value { font-family:'Syne',sans-serif; font-size:1.6rem; font-weight:800; line-height:1; }
        .pct-box-sub { font-size:0.72rem; color:var(--muted); margin-top:3px; }
        .pct-safe    { color:var(--accent); }
        .pct-warning { color:var(--warn); }
        .pct-danger  { color:var(--danger); }
        .pct-muted   { color:var(--muted); }

        /* Draining bar */
        .bar-wrap { margin-bottom:1rem; }
        .bar-labels-top { display:flex; justify-content:space-between; font-size:0.72rem; color:var(--muted); margin-bottom:5px; }
        .countdown-bar {
            position:relative; height:10px;
            background:rgba(255,255,255,0.06); border-radius:99px; overflow:hidden;
        }
        .danger-line {
            position:absolute; left:80%; top:0; bottom:0;
            width:2px; background:var(--danger); opacity:0.7; z-index:2;
        }
        /* anchored LEFT, grows rightward as attendance builds */
        .bar-fill {
            position:absolute; left:0; top:0; bottom:0;
            border-radius:99px; transition:width 0.8s cubic-bezier(.4,0,.2,1);
        }
        .fill-safe    { background:linear-gradient(90deg,var(--accent2),var(--accent)); }
        .fill-warning { background:linear-gradient(90deg,#F59E0B,var(--warn)); }
        .fill-danger  { background:linear-gradient(90deg,#DC2626,var(--danger)); }
        .bar-labels-bot { display:flex; justify-content:space-between; font-size:0.68rem; color:var(--muted); margin-top:4px; }
        .danger-label-txt { color:rgba(248,113,113,0.8); }

        /* ===== VIBE BOX ‚Äî the fun part ===== */
        .vibe-box {
            border-radius:12px; padding:1rem 1.1rem;
            margin-bottom:1rem; border:1px solid;
            display:flex; gap:0.85rem; align-items:flex-start;
        }
        .vibe-safe    { background:rgba(110,231,183,0.07); border-color:rgba(110,231,183,0.2); }
        .vibe-warning { background:rgba(251,191,36,0.07);  border-color:rgba(251,191,36,0.2); }
        .vibe-danger  { background:rgba(248,113,113,0.07); border-color:rgba(248,113,113,0.25); }
        .vibe-cooked  { background:rgba(248,113,113,0.12); border-color:rgba(248,113,113,0.4); animation:pulse 1.5s ease-in-out infinite; }

        @keyframes pulse {
            0%,100% { border-color:rgba(248,113,113,0.4); }
            50%      { border-color:rgba(248,113,113,0.9); }
        }

        .vibe-label {
            font-family:'Syne',sans-serif; font-size:1rem; font-weight:800;
            letter-spacing:0.04em; white-space:nowrap;
            line-height:1.2; margin-bottom:4px;
        }
        .vibe-safe    .vibe-label { color:var(--accent); }
        .vibe-warning .vibe-label { color:var(--warn); }
        .vibe-danger  .vibe-label { color:var(--danger); }
        .vibe-cooked  .vibe-label { color:var(--danger); }

        .vibe-detail { font-size:0.83rem; color:var(--muted); line-height:1.5; }

        /* Bunk/makeup quick stat */
        .bunk-stat {
            display:inline-flex; align-items:center; gap:6px;
            font-family:'Syne',sans-serif; font-size:0.82rem; font-weight:700;
            border-radius:8px; padding:0.3rem 0.8rem; border:1px solid;
            margin-top:8px;
        }
        .bunk-stat-safe   { background:rgba(110,231,183,0.1); border-color:rgba(110,231,183,0.25); color:var(--accent); }
        .bunk-stat-warn   { background:rgba(251,191,36,0.1);  border-color:rgba(251,191,36,0.25);  color:var(--warn); }
        .bunk-stat-danger { background:rgba(248,113,113,0.1); border-color:rgba(248,113,113,0.3);  color:var(--danger); }

        .card-divider { height:1px; background:var(--border); margin:1rem 0; }

        /* Edit timetable */
        .edit-tt-btn { font-size:0.73rem; color:var(--muted); background:transparent; border:1px solid var(--border); border-radius:7px; padding:0.22rem 0.65rem; cursor:pointer; transition:color 0.2s,border-color 0.2s; }
        .edit-tt-btn:hover { color:var(--accent); border-color:rgba(110,231,183,0.3); }
        .edit-tt-form { display:none; margin-top:0.75rem; }
        .edit-tt-form.open { display:block; }
        .btn-save-tt { font-family:'Syne',sans-serif; font-size:0.75rem; font-weight:700; letter-spacing:0.05em; text-transform:uppercase; background:rgba(110,231,183,0.12); border:1px solid rgba(110,231,183,0.25); color:var(--accent); border-radius:8px; padding:0.4rem 1rem; cursor:pointer; transition:background 0.2s; margin-top:0.6rem; }
        .btn-save-tt:hover { background:rgba(110,231,183,0.22); }

        /* Action buttons */
        .action-row { display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center; }
        .btn-present,.btn-absent,.btn-delete { font-family:'Syne',sans-serif; font-size:0.8rem; font-weight:700; letter-spacing:0.05em; text-transform:uppercase; border-radius:8px; padding:0.45rem 1rem; text-decoration:none; border:1px solid; cursor:pointer; transition:background 0.2s,transform 0.15s; }
        .btn-present { background:rgba(110,231,183,0.1); border-color:rgba(110,231,183,0.25); color:var(--accent); }
        .btn-present:hover { background:rgba(110,231,183,0.2); color:var(--accent); transform:translateY(-1px); }
        .btn-absent  { background:rgba(248,113,113,0.1); border-color:rgba(248,113,113,0.25); color:var(--danger); }
        .btn-absent:hover  { background:rgba(248,113,113,0.2); color:var(--danger); transform:translateY(-1px); }
        .btn-delete  { background:transparent; border-color:var(--border); color:var(--muted); margin-left:auto; }
        .btn-delete:hover  { color:var(--danger); border-color:rgba(248,113,113,0.35); }
        .btn-disabled { opacity:0.3; pointer-events:none; }

        .today-empty { text-align:center; padding:2.5rem 1rem; color:var(--muted); }
        .today-empty .icon { font-size:2rem; margin-bottom:0.75rem; }
        .empty-state { text-align:center; padding:3rem 1rem; color:var(--muted); }
        .empty-state .icon { font-size:2.5rem; margin-bottom:1rem; }
    </style>
</head>
<body>

<div class="topbar">
    <a href="/" class="brand"><span class="brand-dot"></span>Attendance</a>
    <div style="display:flex;gap:0.5rem;align-items:center;">
        <button onclick="getWidgetURL()" class="btn-logout" style="cursor:pointer;">üì≤ Widget URL</button>
        <a href="/logout" class="btn-logout">Logout</a>
    </div>
</div>

<!-- Widget URL modal -->
<div id="widget-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;align-items:center;justify-content:center;">
    <div style="background:#13161e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:1.5rem;max-width:400px;width:90%;position:relative;">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:1.1rem;margin-bottom:0.5rem;">üì≤ Your Widget URL</div>
        <p style="font-size:0.83rem;color:#6b7280;margin-bottom:1rem;">Copy this URL into KWGT ‚Üí Web Content widget. It shows your live attendance without needing to log in.</p>
        <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:0.75rem;font-size:0.78rem;word-break:break-all;color:#6EE7B7;margin-bottom:1rem;" id="widget-url-text">Loading...</div>
        <div style="display:flex;gap:0.5rem;">
            <button onclick="copyWidgetURL()" style="flex:1;font-family:'Syne',sans-serif;font-weight:700;font-size:0.82rem;background:linear-gradient(135deg,#6EE7B7,#3B82F6);border:none;border-radius:10px;color:#0d0f14;padding:0.6rem;cursor:pointer;">Copy URL</button>
            <button onclick="closeWidgetModal()" style="font-family:'Syne',sans-serif;font-weight:700;font-size:0.82rem;background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#6b7280;padding:0.6rem 1rem;cursor:pointer;">Close</button>
        </div>
        <p style="font-size:0.72rem;color:#6b7280;margin-top:0.75rem;">Steps: Install KWGT ‚Üí add widget ‚Üí tap edit ‚Üí add "Web" module ‚Üí paste URL</p>
    </div>
</div>

<div class="content">
<div class="container" style="max-width:680px;">

    <div class="page-header">
        <h1>üìö Attendance</h1>
        <p>Safe zone: <strong style="color:var(--accent)">{{ bunk_limit }}%</strong> &nbsp;¬∑&nbsp; Today: <strong>{{ today_name }}</strong></p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('today',this)">Today</button>
        <button class="tab-btn"        onclick="switchTab('all',  this)">All Subjects</button>
        <button class="tab-btn"        onclick="switchTab('add',  this)">+ Add</button>
    </div>

    <!-- TODAY -->
    <div id="tab-today" class="tab-pane active">
        {% if todays_subjects %}
        <p style="color:var(--muted);font-size:0.85rem;margin-bottom:1rem;">{{ todays_subjects|length }} class{{ 'es' if todays_subjects|length != 1 }} today</p>
        {% for s in todays_subjects %}
        <div class="today-card status-{{ s.status }}" style="animation-delay:{{ loop.index0*0.06 }}s">
            <div class="today-info">
                <div class="today-name">{{ s.name }}</div>
                <div class="today-meta">
                    {{ s.semester }} ¬∑ {{ s.attended }}/{{ s.total_classes }} attended<br>
                    <span style="font-family:'Syne',sans-serif;font-size:0.8rem;font-weight:700;">
                        {% if s.classes_held >= (s.total_classes * 2 / 3) %}{{ s.vibe }}{% else %}üïê too early to judge{% endif %}
                    </span>
                </div>
            </div>
            <div style="text-align:right;">
                <div class="today-pct pct-{{ s.status }}">{{ s.projected_pct }}%</div>
                <div style="font-size:0.7rem;color:var(--muted);">projected</div>
            </div>
            <div class="today-actions">
                {% if s.classes_held < s.total_classes %}
                <a href="/mark/{{ s.id }}/present" class="btn-present">‚úì</a>
                <a href="/mark/{{ s.id }}/absent"  class="btn-absent">‚úó</a>
                {% else %}
                <span class="btn-present btn-disabled">‚úì</span>
                <span class="btn-absent  btn-disabled">‚úó</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="today-empty">
            <div class="icon">üéâ</div>
            <p>No classes today ‚Äî go touch some grass.</p>
        </div>
        {% endif %}
    </div>

    <!-- ALL SUBJECTS -->
    <div id="tab-all" class="tab-pane">
        {% if semesters %}
        {% for semester, subjects in semesters.items()|sort %}
        <div class="semester-header">
            <span class="semester-badge">{{ semester }}</span>
            <div class="semester-line"></div>
            <span style="font-size:0.8rem;color:var(--muted)">{{ subjects|length }} subject{{ 's' if subjects|length != 1 }}</span>
        </div>

        {% for s in subjects %}
        <div class="subject-card status-{{ s.status }}" style="animation-delay:{{ loop.index0*0.07 }}s">

            <div class="subject-top">
                <div class="subject-name">{{ s.name }}</div>
                <span class="held-badge">{{ s.classes_held }}/{{ s.total_classes }} held</span>
            </div>

            <div class="days-row">
                {% for i, short in [(0,'M'),(1,'T'),(2,'W'),(3,'Th'),(4,'F'),(5,'Sa'),(6,'Su')] %}
                <span class="day-pill {{ 'day-pill-on' if i in s.days_scheduled else 'day-pill-off' }}">{{ short }}</span>
                {% endfor %}
                <button class="edit-tt-btn ms-auto" onclick="toggleTT({{ s.id }})">Edit days</button>
            </div>

            <div class="edit-tt-form" id="tt-{{ s.id }}">
                <form action="/timetable/update/{{ s.id }}" method="POST">
                    <div class="day-picker">
                        {% for i, day in [(0,'Mon'),(1,'Tue'),(2,'Wed'),(3,'Thu'),(4,'Fri'),(5,'Sat'),(6,'Sun')] %}
                        <input type="checkbox" id="edit-day-{{ s.id }}-{{ i }}" name="days" value="{{ i }}" {{ 'checked' if i in s.days_scheduled }}>
                        <label class="day-label" for="edit-day-{{ s.id }}-{{ i }}">{{ day }}</label>
                        {% endfor %}
                    </div>
                    <button type="submit" class="btn-save-tt">Save Schedule</button>
                </form>
            </div>

            <!-- Dual % boxes -->
            <div class="pct-display">
                <div class="pct-box">
                    <div class="pct-box-label">Right now</div>
                    <div class="pct-box-value pct-{{ s.status }}">{{ s.realtime_pct }}%</div>
                    <div class="pct-box-sub">{{ s.attended }} / {{ s.classes_held }} classes held</div>
                </div>
                <div class="pct-box">
                    <div class="pct-box-label">End of semester</div>
                    <div class="pct-box-value pct-{{ s.status }}">{{ s.projected_pct }}%</div>
                    <div class="pct-box-sub">{{ s.attended }} / {{ s.total_classes }} total classes</div>
                </div>
            </div>

            <!-- Draining bar ‚Äî anchored right, shrinks left -->
            <div class="bar-wrap">
                <div class="bar-labels-top">
                    <span>semester progress</span>
                    <span>{{ s.remaining }} classes left</span>
                </div>
                <div class="countdown-bar">
                    <div class="danger-line"></div>
                    <div class="bar-fill fill-{{ s.status }}" style="width:{{ s.pct }}%"></div>
                </div>
                <div class="bar-labels-bot">
                    <span>0%</span>
                    <span class="danger-label-txt">‚Üë {{ bunk_limit }}% cutoff</span>
                    <span>100%</span>
                </div>
            </div>

            <!-- VIBE BOX ‚Äî only shows after 2/3 of semester is done -->
            {% if s.classes_held >= (s.total_classes * 2 / 3) %}
            <div class="vibe-box {{ 'vibe-cooked' if s.cooked else 'vibe-' + s.status }}">
                <div>
                    <div class="vibe-label">{{ s.vibe }}</div>
                    <div class="vibe-detail">{{ s.vibe_detail }}</div>
                    <!-- Quick stat -->
                    {% if s.classes_held >= s.total_classes %}
                        <span class="bunk-stat bunk-stat-safe">‚úì Final: {{ s.projected_pct }}%</span>
                    {% elif s.cooked %}
                        <span class="bunk-stat bunk-stat-danger">Max possible: {{ s.max_possible }}%</span>
                    {% elif s.status == 'safe' and s.safe_to_bunk > 0 %}
                        <span class="bunk-stat bunk-stat-safe">üõå {{ s.safe_to_bunk }} bunk{{ 's' if s.safe_to_bunk != 1 }} left</span>
                    {% elif s.status == 'safe' %}
                        <span class="bunk-stat bunk-stat-warn">‚ö†Ô∏è 0 bunks left</span>
                    {% else %}
                        <span class="bunk-stat bunk-stat-danger">üìñ attend {{ s.need_to_attend }} to recover</span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <!-- Early semester ‚Äî too soon to judge -->
            <div style="font-size:0.8rem;color:var(--muted);padding:0.5rem 0 0.75rem;font-style:italic;">
                üïê Check back after {{ ((s.total_classes * 2 / 3) | int) - s.classes_held }} more class{{ 'es' if ((s.total_classes * 2 / 3) | int) - s.classes_held != 1 }} for your vibe check
            </div>
            {% endif %}

            <div class="card-divider"></div>

            <div class="action-row">
                {% if s.classes_held < s.total_classes %}
                <a href="/mark/{{ s.id }}/present" class="btn-present">‚úì Present</a>
                <a href="/mark/{{ s.id }}/absent"  class="btn-absent">‚úó Absent</a>
                {% else %}
                <span class="btn-present btn-disabled">‚úì Present</span>
                <span class="btn-absent  btn-disabled">‚úó Absent</span>
                {% endif %}
                <form action="/delete/{{ s.id }}" method="POST" style="margin-left:auto" onsubmit="return confirm('Delete {{ s.name }}?')">
                    <button type="submit" class="btn-delete">Delete</button>
                </form>
            </div>

        </div>
        {% endfor %}
        {% endfor %}

        {% else %}
        <div class="empty-state">
            <div class="icon">üì≠</div>
            <p>No subjects yet. Hit "+ Add" to get started!</p>
        </div>
        {% endif %}
    </div>

    <!-- ADD -->
    <div id="tab-add" class="tab-pane">
        <div class="add-card">
            <div class="add-card-title">New Subject</div>
            <form action="/add" method="POST">
                <div class="row g-2">
                    <div class="col-12 col-sm-5">
                        <input type="text" name="name" class="form-control" placeholder="Subject name" required>
                    </div>
                    <div class="col-6 col-sm-3">
                        <select name="semester" class="form-select" required>
                            <option value="" disabled selected>Semester</option>
                            {% for i in range(1,9) %}<option value="Semester {{ i }}">Sem {{ i }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-6 col-sm-4">
                        <input type="number" name="total_classes" class="form-control" placeholder="Total classes" min="1" max="300" required>
                        <div class="form-hint">Total for the whole semester</div>
                    </div>
                </div>
                <div style="margin-top:1rem;">
                    <div class="form-hint" style="margin-bottom:6px;">Days this class happens:</div>
                    <div class="day-picker">
                        {% for i, day in [(0,'Mon'),(1,'Tue'),(2,'Wed'),(3,'Thu'),(4,'Fri'),(5,'Sat'),(6,'Sun')] %}
                        <input type="checkbox" id="add-day-{{ i }}" name="days" value="{{ i }}">
                        <label class="day-label" for="add-day-{{ i }}">{{ day }}</label>
                        {% endfor %}
                    </div>
                </div>
                <button type="submit" class="btn-add">Add Subject</button>
            </form>
        </div>
    </div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function switchTab(name, btn) {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
        btn.classList.add('active');
    }
    function toggleTT(id) {
        document.getElementById('tt-' + id).classList.toggle('open');
    }

    // Widget URL
    function getWidgetURL() {
        const modal = document.getElementById('widget-modal');
        modal.style.display = 'flex';
        fetch('/widget/token')
            .then(r => r.json())
            .then(data => {
                document.getElementById('widget-url-text').textContent = data.url;
            });
    }
    function copyWidgetURL() {
        const url = document.getElementById('widget-url-text').textContent;
        navigator.clipboard.writeText(url).then(() => {
            const btn = event.target;
            btn.textContent = '‚úì Copied!';
            setTimeout(() => btn.textContent = 'Copy URL', 2000);
        });
    }
    function closeWidgetModal() {
        document.getElementById('widget-modal').style.display = 'none';
    }
    // Close modal on backdrop click
    document.getElementById('widget-modal').addEventListener('click', function(e) {
        if (e.target === this) closeWidgetModal();
    });

    // ‚îÄ‚îÄ PWA: Register service worker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
            .then(reg => {
                console.log('SW registered:', reg.scope);
                // Schedule smart daily notification check
                scheduleDailyCheck(reg);
            })
            .catch(err => console.log('SW registration failed:', err));
    }

    // ‚îÄ‚îÄ Smart notification: only fires once per day, only if needed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function scheduleDailyCheck(reg) {
        const LAST_CHECK_KEY = 'attendance_last_notif_check';
        const now = Date.now();
        const lastCheck = parseInt(localStorage.getItem(LAST_CHECK_KEY) || '0');
        const ONE_DAY_MS = 24 * 60 * 60 * 1000;

        // Only check once per day
        if (now - lastCheck < ONE_DAY_MS) return;

        // Ask for notification permission if not granted
        if (Notification.permission === 'default') {
            Notification.requestPermission();
            return; // Will check properly next time
        }
        if (Notification.permission !== 'granted') return;

        // Fetch attendance alerts from server
        fetch('/push/check')
            .then(r => r.json())
            .then(data => {
                localStorage.setItem(LAST_CHECK_KEY, now.toString());
                if (!data.alerts || data.alerts.length === 0) return;

                // Build one clean summary notification (not one per subject ‚Äî no spam)
                const urgent   = data.alerts.filter(a => a.urgent);
                const warnings = data.alerts.filter(a => !a.urgent);

                let title, body;
                if (urgent.length > 0) {
                    title = `üö® ${urgent.length} subject${urgent.length > 1 ? 's' : ''} need attention`;
                    body  = urgent.slice(0, 2).map(a => a.msg).join('\n');
                    if (urgent.length > 2) body += `\n+${urgent.length - 2} more`;
                } else {
                    title = `‚ö†Ô∏è Attendance heads up`;
                    body  = warnings.slice(0, 2).map(a => a.msg).join('\n');
                }

                // Show via service worker (works in background)
                reg.showNotification(title, {
                    body,
                    icon:     '/static/icons/icon-192.png',
                    badge:    '/static/icons/icon-192.png',
                    tag:      'attendance-daily',   // replaces any previous one ‚Äî no spam
                    renotify: false,
                    data:     { url: '/' },
                });
            })
            .catch(() => {}); // Fail silently ‚Äî it'll try again tomorrow
    }

    // ‚îÄ‚îÄ Install prompt (Android) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault();
        deferredPrompt = e;
        // Show install banner after 3 seconds if not already installed
        setTimeout(() => {
            const banner = document.getElementById('install-banner');
            if (banner) banner.style.display = 'flex';
        }, 3000);
    });

    function installApp() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
            deferredPrompt = null;
            const banner = document.getElementById('install-banner');
            if (banner) banner.style.display = 'none';
        });
    }
</script>

<!-- Install banner (Android ‚Äî auto shows after 3s if installable) -->
<div id="install-banner" style="
    display:none; position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%);
    background:#13161e; border:1px solid rgba(110,231,183,0.3); border-radius:14px;
    padding:0.9rem 1.2rem; gap:1rem; align-items:center; z-index:999;
    box-shadow:0 8px 32px rgba(0,0,0,0.5); max-width:340px; width:90%;
">
    <span style="font-size:1.4rem;">üì≤</span>
    <div style="flex:1;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:0.9rem;">Install App</div>
        <div style="font-size:0.78rem;color:#6b7280;">Add to home screen for the full experience</div>
    </div>
    <button onclick="installApp()" style="font-family:'Syne',sans-serif;font-weight:700;font-size:0.78rem;background:linear-gradient(135deg,#6EE7B7,#3B82F6);border:none;border-radius:8px;padding:0.4rem 0.9rem;color:#0d0f14;cursor:pointer;">Install</button>
    <button onclick="document.getElementById('install-banner').style.display='none'" style="background:transparent;border:none;color:#6b7280;cursor:pointer;font-size:1.1rem;padding:0;">‚úï</button>
</div>

</body>
</html>